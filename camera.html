<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Rehab Assistant</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js"></script>
</head>
<body>
  <nav class="navbar">
    <ul>
      <li><a href="home.html">Home</a></li>
      <li><a href="camera.html" class="active">Camera</a></li>
      <li><a href="exercises.html">Exercises</a></li>
    </ul>
  </nav>

  <div id="webcam-container">
    <h1>Camera</h1>
    <h2>Start exercising using pose recognition!</h2>

    <div class="exercise-buttons">
      <button onclick="selectExercise('squat')" class="exercise-btn">Squat</button>
      <button onclick="selectExercise('wallPushup')" class="exercise-btn">Wall Pushup</button>
      <button onclick="selectExercise('balance')" class="exercise-btn">Standing Balance</button>
    </div>

    <button onclick="init()" id="startBtn" disabled>Start Pose Detection</button>
    <br /><br />
    <canvas id="canvas" aria-label="Webcam video and pose overlay"></canvas>
    <div id="label-container" aria-live="polite"></div>
  </div>

  <script>
    const URL = "https://teachablemachine.withgoogle.com/models/k4i2TNGru/";
    let model, webcam, ctx, labelContainer, maxPredictions;
    let selectedExercise = '';

    function selectExercise(exercise) {
      selectedExercise = exercise;
      
      // Update button styles
      document.querySelectorAll('.exercise-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      // Only enable start button for squat
      const startBtn = document.getElementById('startBtn');
      if (exercise === 'squat') {
        startBtn.disabled = false;
      } else {
        startBtn.disabled = true;
        labelContainer = document.getElementById("label-container");
        labelContainer.innerHTML = '<div class="instructions">Coming soon!</div>';
        return;
      }

      const instructions = {
    squat: `
        <div class="instructions-detailed">
            <h3>Proper Squat Form</h3>
            <div class="instruction-step">
                <img src="images/squat-start.png" alt="Starting position">
                <div class="step-content">
                    <h4>Step 1: Starting Position</h4>
                    <ul>
                        <li>Stand with feet shoulder-width apart</li>
                        <li>Toes slightly pointed outward</li>
                    </ul>
                </div>
            </div>
            <div class="instruction-step">
                <img src="images/squat-descent.png" alt="Squat descent">
                <div class="step-content">
                    <h4>Step 2: The Descent</h4>
                    <ul>
                        <li>Hinge at the hips and push your buttocks back</li>
                        <li>Lower as if sitting back in a chair</li>
                        <li>Keep your chest up and back straight</li>
                    </ul>
                </div>
            </div>
            <div class="instruction-step">
                <img src="images/squat-bottom.png" alt="Bottom position">
                <div class="step-content">
                    <h4>Step 3: Bottom Position</h4>
                    <ul>
                        <li>Lower until your thighs are parallel to the ground</li>
                        <li>Ensure your knees are aligned with your toes</li>
                        <li>Maintain a neutral spine</li>
                    </ul>
                </div>
            </div>
            <div class="instruction-step">
                <img src="images/squat-rise.png" alt="Rising position">
                <div class="step-content">
                    <h4>Step 4: The Rise</h4>
                    <ul>
                        <li>Push through your heels</li>
                        <li>Inhale as you lower, exhale as you push</li>
                        <li>Return to starting position</li>
                        <li>Instructions provided by <a href="https://health.clevelandclinic.org/proper-squat-form" target="_blank">Cleveland Health Clinic</a></li>
                    </ul>
                </div>
            </div>
        </div>
    `,
    wallPushup: "Coming soon!",
    balance: "Coming soon!"
};

      labelContainer = document.getElementById("label-container");
      labelContainer.innerHTML = `<div class="instructions">${instructions[exercise]}</div>`;
    }

    async function init() {
      if (selectedExercise !== 'squat') {
        return;
      }

      const modelURL = URL + "model.json";
      const metadataURL = URL + "metadata.json";

      // Show loading state
      labelContainer = document.getElementById("label-container");
      labelContainer.innerHTML = '<div class="instructions">Loading squat model...</div>';

      try {
        model = await tmPose.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();

        const size = 400;
        const flip = true;
        webcam = new tmPose.Webcam(size, size, flip);
        await webcam.setup();
        await webcam.play();
        window.requestAnimationFrame(loop);

        const canvas = document.getElementById("canvas");
        canvas.width = size;
        canvas.height = size;
        ctx = canvas.getContext("2d");

        labelContainer.innerHTML = '';
        for (let i = 0; i < maxPredictions; i++) {
          labelContainer.appendChild(document.createElement("div"));
        }
      } catch (error) {
        console.error('Error loading model:', error);
        labelContainer.innerHTML = '<div class="instructions">Error loading model. Please try again.</div>';
      }
    }

    async function loop(timestamp) {
      webcam.update();
      await predict();
      window.requestAnimationFrame(loop);
    }

    async function predict() {
      const { pose, posenetOutput } = await model.estimatePose(webcam.canvas);
      const prediction = await model.predict(posenetOutput);

      for (let i = 0; i < maxPredictions; i++) {
        const classPrediction = prediction[i].className + ": " + prediction[i].probability.toFixed(2);
        labelContainer.childNodes[i].innerHTML = classPrediction;
      }

      if (pose && selectedExercise === 'squat') {
        checkSquatForm(pose);
      }

      drawPose(pose);
    }

    function drawPose(pose) {
      if (webcam.canvas) {
        ctx.drawImage(webcam.canvas, 0, 0);
        if (pose) {
          const minPartConfidence = 0.5;
          tmPose.drawKeypoints(pose.keypoints, minPartConfidence, ctx);
          tmPose.drawSkeleton(pose.keypoints, minPartConfidence, ctx);
        }
      }
    }

    function checkSquatForm(pose) {
      if (pose.keypoints) {
        const hip = pose.keypoints.find(kp => kp.part === "leftHip");
        const knee = pose.keypoints.find(kp => kp.part === "leftKnee");
        if (hip && knee && hip.score > 0.5 && knee.score > 0.5) {
          if (hip.position.y < knee.position.y) {
            labelContainer.innerHTML += "<div class='instructions'>Keep going lower!</div>";
          }
        }
      }
    }
  </script>
</body>

<footer>
  <p>&copy; 2025 Rehab Buddy. All rights reserved.</p>
</footer>

</html>